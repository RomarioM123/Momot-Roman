#include "malwareList.h"

void MalwareList::createList(int value, CAuthor* authors)
{
	size = value;
	list = new CMalware[value];

	for (size_t i = 0; i < value; i++)
		list[i] = programs(i, authors);
}

void MalwareList::setListSize(int size) { this->size = size; }
int MalwareList::getListSize() const { return size; }

void MalwareList::printAll() const
{
	cout << endl << setiosflags(ios::left);
	cout << setw(12) << "  Время" << setw(12) << "Размер";
	cout << setw(10) << "Строки" << setw(11) << "Интернет";
	cout << setw(14) << "Индекс" << setw(21) << "Название";
	cout << setw(16) << "Год выпуска" << setw(14) << "Автор";
	cout << setw(14) << "Тип" << endl;

	for (size_t i = 0; i < size; i++)
		printOneEl(i);

	cout << endl;
}
void MalwareList::printOneEl(int number) const
{
	cout << setiosflags(ios::left) << setw(2) << number + 1 << ")";
	cout << setw(10) << list[number].getTime();
	cout << setw(12) << list[number].getSize();
	cout << setw(9) << list[number].getLines();
	cout << setw(12) << boolalpha << list[number].getInternet();
	cout << setw(11) << list[number].getIndex();
	cout << setw(26) << list[number].getName();
	cout << setw(14) << list[number].getYear();
	cout << setw(12) << list[number].getAuthor();
	cout << setw(14) << list[number].getType() << endl;
}
void MalwareList::addEl(CMalware& newProgram)
{
	CMalware* newList = new CMalware[size + 1];

	for (size_t i = 0; i < size; i++)
		newList[i] = list[i];
	newList[size++] = newProgram;
	delete[] list;

	list = new CMalware[size];
	for (size_t i = 0; i < size; i++)
		list[i] = newList[i];

	delete[] newList;
	cout << "Элемент добавлен." << endl;
}
void MalwareList::deleteEl(int index)
{
	if (size == 0)
	{
		cout << "список программ пуст. возвращение с выбору действий." << endl;
		return;
	}
	if (index <= 0 || index > size)
	{
		cout << "ошибка. неверный номер элемента. вовзвращение." << endl;
		return;
	}

	CMalware* newList = new CMalware[size - 1];

	for (size_t i = 0; i < index - 1; i++)
		newList[i] = list[i];
	for (size_t i = index - 1, j = index; j < size; i++, j++)
		newList[i] = list[j];
	delete[] list;

	list = new CMalware[size--];
	for (size_t i = 0; i < size; i++)
		list[i] = newList[i];
	delete[] newList;

	return;
}
int MalwareList::task(int minimalSize)
{
	int size2 = 0;

	for (size_t i = 0; i < size; i++)
		if (list[i].getSize() > minimalSize && list[i].getType() == "Trojan")
		{
			printOneEl(i);
			size2++;
		}

	return size2;
}
int MalwareList::linesInFile(string filename)
{
	int size = 0;
	string line;
	regex regular("([\\d]* [\\d]* [\\wА-Яа-я]* [\\d]* [\\d]* [true|false]* [\\w]* [\\d]* [\\d]* [\\d]* [A-ZА-Я]+[\\wА-Яа-я,.;:-]* [\\wА-Яа-я,.;:-]*)");

	ifstream fin(filename);
	if (!fin.is_open())
	{
		cout << "Невозможно открыть файл. Возвращение в меню." << endl;
		return 0;
	}

	while (getline(fin, line))
	{
		if (regex_match(line, regular))	size++;
		else cout << "Строка в файле не прошла проверку." << endl;
	}

	fin.close();
	return size;
}
void MalwareList::readFile(string filename)
{
	ifstream fin(filename);
	if (!fin.is_open())
	{
		cout << "Неверное название файла. Повторите попытку." << endl;
		return;
	}

	string line, var;
	int size = MalwareList::linesInFile(filename);
	regex regular("([\\d]* [\\d]* [\\wА-Яа-я]* [\\d]* [\\d]* [true|false]* [\\w]* [\\d]* [\\d]* [\\d]* [A-ZА-Я]+[\\wА-Яа-я,.;:-]* [\\wА-Яа-я,.;:-]*)");
	int i = 0, a = 0;
	bool b;

	delete[] list;
	list = new CMalware[size];
	while (getline(fin, line) && i < size)
	{
		if (regex_match(line.c_str(), regular))
		{
			int time, size, lines, index;
			sint day, month, year;
			string name, name2;
			string internet2;
			bool internet;
			string author;
			string type;

			std::istringstream temp(line);

			temp >> index;
			temp >> time;
			temp >> type;
			temp >> size;
			temp >> lines;
			temp >> internet2;
			temp >> author;
			temp >> day;
			temp >> month;
			temp >> year;
			temp >> name;
			temp >> name2;

			if (internet2 == "true") internet = true;
			else internet = false;

			if (name2 == "") name = name + " ";
			else(name = name + " " + name2);

			do {
				b = 0;

				a = name.find("--");
				if (a != -1)
				{
					name.erase(a, 1);
					b = 1;
				}

				a = name.find("  ");
				if (a != -1)
				{
					name.erase(a, 1);
					b = 1;
				}

				a = name.find(",,");
				if (a != -1)
				{
					name.erase(a, 1);
					b = 1;
				}

				a = name.find("::");
				if (a != -1)
				{
					name.erase(a, 1);
					b = 1;
				}

				a = name.find(";;");
				if (a != -1)
				{
					name.erase(a, 1);
					b = 1;
				}

				a = name.find("_");
				if (a != -1)
				{
					name.erase(a, 1);
					b = 1;
				}

			} while (b == 1);

			CMalware newElement(internet, time, size, lines, index, name, author, day, month, year, type);
			list[i++] = newElement;
		}
	}

	setListSize(size);
	fin.close();
	cout << endl << "Чтение из файла завершено." << endl;
}
void MalwareList::saveToFile(string filename)
{
	std::ofstream fout(filename);

	fout.setf(ios::left);
	fout << setw(12) << "  Время" << setw(12) << "Размер";
	fout << setw(13) << "Строки" << setw(11) << "Интернет";
	fout << setw(15) << "Индекс" << setw(24) << "Название";
	fout << setw(16) << "Год выпуска" << setw(14) << "Автор";
	fout << setw(12) << "Тип" << endl;

	for (size_t i = 0; i < getListSize(); i++)
	{
		fout << setiosflags(ios::left) << setw(2) << i + 1 << ")";
		fout << setw(10) << list[i].getTime();
		fout << setw(12) << list[i].getSize();
		fout << setw(12) << list[i].getLines();
		fout << setw(12) << boolalpha << list[i].getInternet();
		fout << setw(15) << list[i].getIndex();
		fout << setw(26) << list[i].getName();
		fout << setw(14) << list[i].getYear();
		fout << setw(12) << list[i].getAuthor();
		fout << setw(12) << list[i].getType() << endl;
	}

	cout << "Запись в файл завершена." << endl;
	fout.close();
}
stringstream MalwareList::getOneEl(int value) const
{
	stringstream temp;

	temp << " " << list[value].getIndex() << " " << list[value].getType() << " " << list[value].getTime() << " " << list[value].getSize()
		<< " " << list[value].getLines() << " " << list[value].getInternet() << " " << list[value].getAuthor()
		<< " " << list[value].getDay() << " " << list[value].getMonth() << " " << list[value].getYear()
		<< " " << list[value].getName();

	return temp;
}
void MalwareList::showOneEl(stringstream& line) const
{
	int time, size, lines, index;
	sint day, month, year;
	string name, name2;
	string internet2;
	bool internet;
	string author;
	string type;

	line >> index;
	line >> type;
	line >> time;
	line >> size;
	line >> lines;
	line >> boolalpha >> internet2;
	line >> author;
	line >> day;
	line >> month;
	line >> year;
	line >> name;
	line >> name2;

	if (internet2 == "1") internet = true;
	else internet = false;

	if (name2 == "") name = name + " ";
	else(name = name + " " + name2);

	cout << endl << setiosflags(ios::left);
	cout << setw(12) << "  Время" << setw(12) << "Размер";
	cout << setw(10) << "Строки" << setw(11) << "Интернет";
	cout << setw(14) << "Индекс" << setw(21) << "Название";
	cout << setw(16) << "Год выпуска" << setw(15) << "Автор";
	cout << setw(13) << "Тип" << endl << "   ";

	cout << setw(10) << time;
	cout << setw(12) << size;
	cout << setw(10) << lines;
	cout << setw(10) << internet;
	cout << setw(14) << index;
	cout << setw(25) << name;
	cout << setw(12) << year;
	cout << setw(15) << author;
	cout << setw(14) << type;
	cout << endl;
}
CMalware MalwareList::getProgramID(int id) const
{
	CMalware newProgram;

	for (size_t i = 0; i < size; i++)
		if (list[i].getIndex() == id)
		{
			printOneEl(i);
			newProgram = list[i];
			return newProgram;
		}
	cout << "\nПрограммы с таким ID нету.\n" << endl;
	return newProgram;
}
CMalware MalwareList::programs(int valueX, CAuthor* authors)
{
	CMalware standartMalware;

	if (valueX == 1)
	{
		CMalware Malware1(true ,222, 222, 222, 1234, "Skype", *(authors), 2, 12, 2002, "Keylogger");
		return Malware1;

		return Malware1;
	}
	else if (valueX == 2)
	{
		CMalware Malware2(true, 333, 333, 666, 5678, "Standart Calculator", *(authors + 1), 13, 3, 1993, "Trojan");
		return Malware2;
	}
	else if (valueX == 3)
	{
		CMalware Malware3(false, 444, 444, 444, 9532, "Domino Super", *(authors + 2), 14, 4, 1944, "Virus");
		return Malware3;
	}
	else if (valueX == 4)
	{
		CMalware Malware4(false, 555, 555, 555, 4356, "Text editor", *(authors + 3), 5, 5, 1995, "Bootkit");
		return Malware4;
	}
	return standartMalware;
}
void MalwareList::enterNewEl()
{
	int time, size, lines, index;
	sint day, month, year;
	string name, name2;
	string internet2;
	bool internet;
	string author;
	string type;
	string data;

	regex regular("([\\d]* [\\d]* [\\wА-Яа-я]* [\\d]* [\\d]* [true|false]* [\\w]* [\\d]* [\\d]* [\\d]* [A-ZА-Я]+[\\wА-Яа-я,.;:-]* [\\wА-Яа-я,.;:-]*)");

	cout << "Введите данные в линию в таком порядке:";
	cout << "Индекс Время Тип Размер Строки Интернет(true/false) Компания День Месяц Год Название" << endl;

	cin.sync();
	getline(cin, data);

	data = data + " ";

	if (regex_match(data, regular))
	{
		std::istringstream temp(data);

		temp >> index;
		temp >> time;
		temp >> type;
		temp >> size;
		temp >> lines;
		temp >> internet2;
		temp >> author;
		temp >> day;
		temp >> month;
		temp >> year;
		temp >> name;
		temp >> name2;

		if (internet2 == "true") internet = true;
		else internet = false;

		if (name2 == "") name = name + " ";
		else(name = name + " " + name2);

		CMalware newMalware(internet, time, size, lines, index, name, author, day, month, year, type);
		addEl(newMalware);
	}
	else
	{
		cout << endl << "Было введено неправильное имя. Формат имени:" << endl;
		cout << "Первое слово в названии программы не должно начинаться с маленькой буквы." << endl;
		cout << "Не должно содержать символы." << endl;
		cout << "Завершение работы функции." << endl;
	}


	return;
}
int MalwareList::regexTask()
{
	int value = 0;
	regex regular("(^[A-ZА-Я]+[\\wА-Яа-я,.;:-]* [\\wА-Яа-я,.;:-]+)");
	int listSize = getListSize();

	for (size_t i = 0; i < listSize; i++)
	{
		if (regex_match(list[i].getName(), regular))
		{
			printOneEl(i);
			value++;
		}
	}
	cout << endl;

	return value;
}

bool MalwareList::sortAsc(const int& a, const int& b) { return a > b; }
bool MalwareList::sortDesc(const int& a, const int& b) { return a < b; }
void MalwareList::sort(comp condition)
{
	CMalware temp;
	int size = getListSize();
	bool pr;

	do {
		pr = 0;
		for (size_t i = 0; i < size - 1; i++)
		{
			if (condition(list[i].getLines(), list[i + 1].getLines()))
			{
				temp = list[i];
				list[i] = list[i + 1];
				list[i + 1] = temp;
				pr = 1;
			}
		}
	} while (pr == 1);
}

MalwareList::~MalwareList()
{
	//cout << "\nВызвался деструктор" << endl;
	delete[] list;
}